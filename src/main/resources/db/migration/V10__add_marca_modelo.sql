-- V10__add_marca_modelo.sql

/*
-- Tablas MARCA y MODELO ya fueron creadas en el intento anterior

CREATE TABLE MARCA (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(50) NOT NULL UNIQUE
);

CREATE TABLE MODELO (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    MARCA_ID NUMBER NOT NULL,
    NOMBRE VARCHAR2(50) NOT NULL,
    CONSTRAINT fk_modelo_marca FOREIGN KEY (MARCA_ID) REFERENCES MARCA(ID),
    CONSTRAINT uq_modelo_marca_nombre UNIQUE (MARCA_ID, NOMBRE)
);
*/

/*
-- Datos de MARCA y MODELO ya fueron insertados en el intento anterior

INSERT INTO MARCA (NOMBRE) VALUES ('Toyota');
INSERT INTO MARCA (NOMBRE) VALUES ('Honda');
-- ... (todos los demás INSERTS de MARCA y MODELO) ...
INSERT INTO MODELO (MARCA_ID, NOMBRE) VALUES (15, 'D-Max');
*/

-- **** INICIO DE LO QUE SÍ DEBE EJECUTARSE ****

-- Actualizar tabla VEHICULO (Solo añadir columnas faltantes: MARCA_ID, MODELO_ID, VERSION)
ALTER TABLE VEHICULO ADD (
    MARCA_ID NUMBER NULL,
    MODELO_ID NUMBER NULL,
    VERSION NUMBER(19,0) NULL
);

-- Establecer valores iniciales para versión y updated_at si son nulos
UPDATE VEHICULO SET
    VERSION = COALESCE(VERSION, 0), -- Pone 0 si es NULL
    UPDATED_AT = COALESCE(UPDATED_AT, SYSTIMESTAMP) -- Pone fecha actual si UPDATED_AT es NULL
WHERE VERSION IS NULL OR UPDATED_AT IS NULL;

-- Añadir llaves foráneas (si no existen)
ALTER TABLE VEHICULO ADD CONSTRAINT fk_vehiculo_marca FOREIGN KEY (MARCA_ID) REFERENCES MARCA(ID);
ALTER TABLE VEHICULO ADD CONSTRAINT fk_vehiculo_modelo FOREIGN KEY (MODELO_ID) REFERENCES MODELO(ID);

-- Opcional: Migrar datos existentes (igual que antes, requiere lógica)
-- UPDATE VEHICULO v SET v.MARCA_ID = (SELECT m.ID FROM MARCA m WHERE lower(m.NOMBRE) = lower(v.MARCA)) WHERE v.MARCA IS NOT NULL AND v.MARCA_ID IS NULL;
-- UPDATE VEHICULO v SET v.MODELO_ID = (SELECT mo.ID FROM MODELO mo WHERE mo.MARCA_ID = v.MARCA_ID AND lower(mo.NOMBRE) = lower(v.MODELO)) WHERE v.MODELO IS NOT NULL AND v.MODELO_ID IS NULL AND v.MARCA_ID IS NOT NULL;

-- Opcional: Eliminar columnas antiguas (¡CUIDADO!)
-- ALTER TABLE VEHICULO DROP COLUMN MARCA;
-- ALTER TABLE VEHICULO DROP COLUMN MODELO;

COMMIT;