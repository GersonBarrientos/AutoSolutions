<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{_layout :: head(~{::title})}">
  <title>Repuestos · AutoSolutions</title>
</head>
<body th:replace="~{_layout :: layout(~{::title}, ~{::section})}">
<section>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1 fw-bold"><i class="bi bi-boxes text-secondary me-2"></i> Inventario de Repuestos</h2>
      <p class="text-muted mb-0">Gestiona stock y precios</p>
    </div>
    <div class="d-flex gap-2">
      <a th:href="@{/repuestos/export.csv(q=${q})}" class="btn btn-outline-secondary">
        <i class="bi bi-download me-1"></i> Exportar CSV
      </a>
      <form th:action="@{/repuestos/import}" method="post" enctype="multipart/form-data" class="d-flex gap-2"
            onsubmit="this.querySelector('button[type=submit]').disabled=true">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <input class="form-control form-control-sm" type="file" name="file" accept=".csv" required>
        <button class="btn btn-outline-primary btn-sm" type="submit">
          <i class="bi bi-upload me-1"></i> Importar CSV
        </button>
      </form>
      <a th:href="@{/repuestos/nuevo}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i> Nuevo Repuesto
      </a>
    </div>
  </div>

  <div th:if="${mensajeExito}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i><span th:text="${mensajeExito}">OK</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${mensajeError}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${mensajeError}">Error</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="card-modern mb-3">
    <div class="card-body">
      <form th:action="@{/repuestos}" method="get" class="row g-3 align-items-center">
        <input type="hidden" name="sort" th:value="${sort}">
        <input type="hidden" name="dir" th:value="${dir}">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input class="form-control border-start-0" name="q" th:value="${q}" placeholder="Buscar por nombre...">
          </div>
        </div>
        <div class="col-md-2">
          <select class="form-select" name="size">
            <option th:value="10" th:selected="${page != null and page.size == 10}">10 por página</option>
            <option th:value="20" th:selected="${page != null and page.size == 20}">20 por página</option>
            <option th:value="50" th:selected="${page != null and page.size == 50}">50 por página</option>
          </select>
        </div>
        <div class="col-md-2 d-flex gap-2">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i> Buscar</button>
          <a th:href="@{/repuestos}" class="btn btn-outline-secondary" title="Limpiar"><i class="bi bi-x-circle"></i></a>
        </div>
      </form>
      <div class="mt-2">
        <small class="text-muted">Encontrados: <b th:text="${page != null ? page.totalElements : (repuestos != null ? #lists.size(repuestos) : 0)}">0</b></small>
      </div>
    </div>
  </div>

  <div class="card-modern">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i> Listado</h5>
    </div>
    <div class="card-body p-0">
      <div th:if="${repuestos != null and !#lists.isEmpty(repuestos)}" class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
          <tr>
            <th width="60">#</th>
            <th>
              <a th:href="@{/repuestos(q=${q}, size=${page.size}, sort='nombre', dir=${dir=='asc' && sort=='nombre' ? 'desc' : 'asc'})}" class="text-decoration-none">
                Nombre
                <i class="bi" th:classappend="${sort=='nombre' && dir=='asc'} ? ' bi-caret-up-fill' : (${sort=='nombre'} ? ' bi-caret-down-fill' : '')"></i>
              </a>
            </th>
            <th width="160" class="text-end">
              <a th:href="@{/repuestos(q=${q}, size=${page.size}, sort='precioUnit', dir=${dir=='asc' && sort=='precioUnit' ? 'desc' : 'asc'})}" class="text-decoration-none">
                Precio
                <i class="bi" th:classappend="${sort=='precioUnit' && dir=='asc'} ? ' bi-caret-up-fill' : (${sort=='precioUnit'} ? ' bi-caret-down-fill' : '')"></i>
              </a>
            </th>
            <th width="140" class="text-center">
              <a th:href="@{/repuestos(q=${q}, size=${page.size}, sort='stock', dir=${dir=='asc' && sort=='stock' ? 'desc' : 'asc'})}" class="text-decoration-none">
                Stock
                <i class="bi" th:classappend="${sort=='stock' && dir=='asc'} ? ' bi-caret-up-fill' : (${sort=='stock'} ? ' bi-caret-down-fill' : '')"></i>
              </a>
            </th>
            <th width="120" class="text-center">Estado</th>
            <th width="260" class="text-center">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="r, i : ${repuestos}">
            <td class="text-muted" th:text="${(page != null ? page.number*page.size : 0) + i.index + 1}">1</td>
            <td class="fw-semibold">
              <a th:href="@{/repuestos/{id}(id=${r.id})}" class="text-decoration-none" th:text="${r.nombre}">Repuesto</a>
            </td>
            <td class="text-end">
              <span class="fw-semibold text-success">
                $<span th:text="${r.precioUnit != null ? #numbers.formatDecimal(r.precioUnit, 1, 2) : '0.00'}">0.00</span>
              </span>
            </td>
            <td class="text-center">
              <span th:if="${r.stock != null and r.stock > 10}" class="badge badge-success">
                <i class="bi bi-check-circle me-1"></i>
                <span th:text="${#numbers.formatDecimal(r.stock, 1, 0)}">0</span>
              </span>
              <span th:if="${r.stock != null and r.stock > 0 && r.stock <= 10}" class="badge badge-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <span th:text="${#numbers.formatDecimal(r.stock, 1, 0)}">0</span>
              </span>
              <span th:if="${r.stock == null or r.stock <= 0}" class="badge bg-danger">
                <i class="bi bi-x-circle me-1"></i> Sin stock
              </span>
            </td>
            <td class="text-center">
              <span th:if="${r.activo}" class="badge badge-success"><i class="bi bi-check-circle me-1"></i> Activo</span>
              <span th:unless="${r.activo}" class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i> Inactivo</span>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <form th:action="@{/repuestos/{id}/toggle-activo(id=${r.id})}" method="post" class="d-inline">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                  <button class="btn btn-outline-secondary" title="Activar/Inactivar">
                    <i class="bi" th:classappend="${r.activo} ? ' bi-toggle-on' : ' bi-toggle-off'"></i>
                  </button>
                </form>
                <a th:href="@{/repuestos/{id}/editar(id=${r.id})}" class="btn btn-outline-primary" title="Editar"><i class="bi bi-pencil"></i></a>
                <button type="button" class="btn btn-outline-danger"
                        th:attr="data-id=${r.id}, data-nombre=${r.nombre}"
                        onclick="confirmarEliminar(this.dataset.id, this.dataset.nombre)" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div th:if="${repuestos == null or #lists.isEmpty(repuestos)}" class="text-center py-5">
        <i class="bi bi-box-seam text-muted" style="font-size:4rem;opacity:.3;"></i>
        <h5 class="mt-3 text-muted">No hay repuestos</h5>
        <a th:href="@{/repuestos/nuevo}" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i> Crear</a>
      </div>
    </div>
  </div>

  <nav th:if="${page != null && page.totalPages > 1}" class="mt-3">
    <ul class="pagination pagination-sm">
      <li class="page-item" th:classappend="${page.first}? 'disabled'">
        <a class="page-link" th:href="@{/repuestos(page=${page.number-1}, size=${page.size}, q=${q}, sort=${sort}, dir=${dir})}">«</a>
      </li>
      <li class="page-item disabled"><span class="page-link" th:text="${page.number+1} + ' / ' + ${page.totalPages}">1 / 1</span></li>
      <li class="page-item" th:classappend="${page.last}? 'disabled'">
        <a class="page-link" th:href="@{/repuestos(page=${page.number+1}, size=${page.size}, q=${q}, sort=${sort}, dir=${dir})}">»</a>
      </li>
    </ul>
  </nav>

  <div class="mt-4">
    <a class="btn btn-outline-secondary" th:href="@{/}"><i class="bi bi-arrow-left me-1"></i> Volver</a>
  </div>

</section>

<!-- Modal eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header border-0">
      <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i> Confirmar Eliminación</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body"><p>¿Eliminar el repuesto <strong id="nombreRepuesto"></strong>?</p></div>
    <div class="modal-footer border-0">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      <form th:action="@{/repuestos/{id}/eliminar(id=0)}" method="post" id="formEliminar">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i> Eliminar</button>
      </form>
    </div>
  </div></div>
</div>

<script>
  function confirmarEliminar(id, nombre) {
    document.getElementById('nombreRepuesto').textContent = nombre;
    document.getElementById('formEliminar').action = '/repuestos/' + id + '/eliminar';
    new bootstrap.Modal(document.getElementById('modalEliminar')).show();
  }
  (function(){
    const input = document.querySelector('input[name=q]');
    let t; if(!input) return;
    input.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=> input.form.submit(), 450); });
  })();
  setTimeout(()=>{ document.querySelectorAll('.alert.show').forEach(a=>new bootstrap.Alert(a).close()); }, 3500);
</script>
</body>
</html>
