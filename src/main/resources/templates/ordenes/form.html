<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{_layout :: head(~{::title})}">
  <title th:text="${orden.id == null ? 'Nueva orden' : ('Editar orden #' + orden.id)}">Orden</title>
</head>

<body th:replace="~{_layout :: layout(~{::title}, ~{::section})}">
<section>

  <h1 class="h4 mb-3" th:text="${orden.id == null ? 'Nueva orden de trabajo' : 'Editar orden de trabajo'}">Orden</h1>

  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span th:text="${error}">Ha ocurrido un error</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <form th:object="${orden}"
        th:action="${orden.id} == null ? @{/ordenes} : @{'/ordenes/' + ${orden.id}}"
        method="post" id="ordenForm" class="needs-validation">

    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Vehículo</label>
        <select class="form-select" th:field="*{vehiculoId}" required>
          <option value="" disabled selected>Seleccione…</option>
          <option th:each="v: ${vehiculos}" th:value="${v.id}"
                  th:text="${(v.placa != null ? v.placa : '') + ' · ' + (v.marca != null ? v.marca.nombre : '') + ' ' + (v.modelo != null ? v.modelo.nombre : '')}">
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Estado</label>
        <select class="form-select" th:field="*{estadoId}" required>
          <option value="" disabled selected>Seleccione…</option>
          <option th:each="e: ${estados}" th:value="${e.id}" th:text="${e.nombre}"></option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Fecha ingreso</label>
        <input class="form-control" type="datetime-local" th:field="*{fechaIngreso}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Salida estimada</label>
        <input class="form-control" type="datetime-local" th:field="*{fechaSalidaEstimada}">
      </div>

      <div class="col-12">
        <label class="form-label">Diagnóstico</label>
        <textarea class="form-control" th:field="*{diagnostico}" rows="2"></textarea>
      </div>

      <div class="col-12">
        <label class="form-label">Observaciones</label>
        <textarea class="form-control" th:field="*{observaciones}" rows="2"></textarea>
      </div>

      <!-- ================== Repuestos ================== -->
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-2"><i class="bi bi-box-seam me-2"></i> Repuestos</h2>
          <button type="button" class="btn btn-sm btn-primary" id="btnAddRepuesto">
            <i class="bi bi-plus-lg me-1"></i> Agregar repuesto
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
            <tr>
              <th style="width:40%">Repuesto</th>
              <th class="text-end" style="width:15%">Cantidad</th>
              <th class="text-end" style="width:20%">Precio</th>
              <th class="text-end" style="width:20%">Total</th>
              <th style="width:5%"></th>
            </tr>
            </thead>
            <tbody id="tbodyRepuestos">
            <!-- Filas existentes -->
            <tr th:each="r, it : *{repuestos}">
              <td>
                <select class="form-select"
                        th:name="${'repuestos[' + it.index + '].repuestoId'}" required>
                  <option value="">Seleccione…</option>
                  <option th:each="rp: ${repuestos}" th:value="${rp.id}"
                          th:text="${rp.nombre}"
                          th:selected="${rp.id == r.repuestoId}"></option>
                </select>
              </td>
              <td>
                <input class="form-control text-end" type="number" min="0" step="0.01"
                       th:name="${'repuestos[' + it.index + '].cantidad'}"
                       th:value="${r.cantidad}" oninput="recalcularFila(this)">
              </td>
              <td>
                <!-- editable u opcional; si va vacío, el servicio toma precio del repuesto en BD -->
                <input class="form-control text-end" type="number" min="0" step="0.01"
                       th:name="${'repuestos[' + it.index + '].precioUnit'}"
                       th:value="${r.precioUnit}" oninput="recalcularFila(this)">
              </td>
              <td>
                <input class="form-control text-end" type="number" min="0" step="0.01" readonly
                       th:name="${'repuestos[' + it.index + '].totalLinea'}"
                       th:value="${r.totalLinea}">
              </td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                  <i class="bi bi-x-lg"></i>
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ================== Servicios ================== -->
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-2"><i class="bi bi-wrench-adjustable-circle me-2"></i> Servicios</h2>
          <button type="button" class="btn btn-sm btn-primary" id="btnAddServicio">
            <i class="bi bi-plus-lg me-1"></i> Agregar servicio
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
            <tr>
              <th style="width:40%">Descripción</th>
              <th class="text-end" style="width:15%">Cantidad</th>
              <th class="text-end" style="width:20%">Precio</th>
              <th class="text-end" style="width:20%">Total</th>
              <th style="width:5%"></th>
            </tr>
            </thead>
            <tbody id="tbodyServicios">
            <!-- Filas existentes -->
            <tr th:each="s, it : *{servicios}">
              <td>
                <input class="form-control" type="text"
                       th:name="${'servicios[' + it.index + '].descripcion'}"
                       th:value="${s.descripcion}" required>
              </td>
              <td>
                <input class="form-control text-end" type="number" min="0" step="0.01"
                       th:name="${'servicios[' + it.index + '].cantidad'}"
                       th:value="${s.cantidad}" oninput="recalcularFila(this)">
              </td>
              <td>
                <input class="form-control text-end" type="number" min="0" step="0.01"
                       th:name="${'servicios[' + it.index + '].precioUnit'}"
                       th:value="${s.precioUnit}" oninput="recalcularFila(this)">
              </td>
              <td>
                <input class="form-control text-end" type="number" min="0" step="0.01" readonly
                       th:name="${'servicios[' + it.index + '].totalLinea'}"
                       th:value="${s.totalLinea}">
              </td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                  <i class="bi bi-x-lg"></i>
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i> Guardar
        </button>
        <a class="btn btn-outline-secondary" th:href="@{/ordenes}">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </a>
      </div>
    </div>
  </form>

  <!-- ========= Template de opciones de repuesto para filas nuevas ========= -->
  <template id="tpl-options-repuesto">
    <option value="">Seleccione…</option>
    <option th:each="rp: ${repuestos}" th:value="${rp.id}" th:text="${rp.nombre}"></option>
  </template>

  <!-- ========= Plantillas de filas (sin th:field; JS les asigna name=) ========= -->
  <template id="tplRowRepuesto">
    <tr>
      <td>
        <select class="form-select"></select>
      </td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" oninput="recalcularFila(this)"></td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" oninput="recalcularFila(this)"></td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" readonly></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  </template>

  <template id="tplRowServicio">
    <tr>
      <td><input class="form-control" type="text" required></td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" oninput="recalcularFila(this)"></td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" oninput="recalcularFila(this)"></td>
      <td><input class="form-control text-end" type="number" min="0" step="0.01" readonly></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  </template>

</section>

<!-- ================== JS ================== -->
<script th:inline="javascript">
  const tbodyRepuestos = document.getElementById('tbodyRepuestos');
  const tbodyServicios = document.getElementById('tbodyServicios');
  const tplOptionsRepuesto = document.getElementById('tpl-options-repuesto');

  document.getElementById('btnAddRepuesto').addEventListener('click', addRepuesto);
  document.getElementById('btnAddServicio').addEventListener('click', addServicio);

  function addRepuesto() {
    const tr = document.getElementById('tplRowRepuesto').content.firstElementChild.cloneNode(true);
    const select = tr.querySelector('select');
    select.innerHTML = tplOptionsRepuesto.innerHTML;
    tbodyRepuestos.appendChild(tr);
    renumerarTabla(tbodyRepuestos, 'repuestos');
  }

  function addServicio() {
    const tr = document.getElementById('tplRowServicio').content.firstElementChild.cloneNode(true);
    tbodyServicios.appendChild(tr);
    renumerarTabla(tbodyServicios, 'servicios');
  }

  function removeRow(btn) {
    const tr = btn.closest('tr');
    const tb = tr.parentElement;
    tr.remove();
    if (tb === tbodyRepuestos) renumerarTabla(tbodyRepuestos, 'repuestos');
    if (tb === tbodyServicios) renumerarTabla(tbodyServicios, 'servicios');
  }

  function renumerarTabla(tbody, prefix) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((tr, idx) => {
      const tds = tr.querySelectorAll('td');

      if (tbody === tbodyRepuestos) {
        // Orden: repuestoId (select), cantidad (input), precioUnit (input), totalLinea (input readonly)
        tds[0].querySelector('select').name = `${prefix}[${idx}].repuestoId`;
        tds[1].querySelector('input').name  = `${prefix}[${idx}].cantidad`;
        tds[2].querySelector('input').name  = `${prefix}[${idx}].precioUnit`;
        tds[3].querySelector('input').name  = `${prefix}[${idx}].totalLinea`;
      } else {
        // Servicios: descripcion, cantidad, precioUnit, totalLinea
        tds[0].querySelector('input').name  = `${prefix}[${idx}].descripcion`;
        tds[1].querySelector('input').name  = `${prefix}[${idx}].cantidad`;
        tds[2].querySelector('input').name  = `${prefix}[${idx}].precioUnit`;
        tds[3].querySelector('input').name  = `${prefix}[${idx}].totalLinea`;
      }
    });
  }

  function recalcularFila(anyInput) {
    const tr = anyInput.closest('tr');
    const nums = Array.from(tr.querySelectorAll('input[type="number"]'));
    // Para repuestos y servicios: nums[0]=cantidad, nums[1]=precio, nums[2]=total
    if (nums.length >= 3) {
      const cantidad = parseFloat(nums[0].value || 0);
      const precio   = parseFloat(nums[1].value || 0);
      nums[2].value  = (cantidad * precio).toFixed(2);
    }
  }
</script>
</body>
</html>
