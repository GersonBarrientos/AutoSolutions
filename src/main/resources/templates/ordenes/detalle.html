<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{_layout :: head(~{::title})}">
  <title th:text="${'Orden #' + (orden != null ? orden.id : '-') }">Orden</title>
</head>

<body th:replace="~{_layout :: layout(~{::title}, ~{::section})}">
<section
  th:with="
    detalles=${orden != null ? orden.detalles : {}},
    servicios=${detalles != null ? detalles.?[tipo != null and tipo.name() == 'SERVICIO'] : {}},
    repuestos=${detalles != null ? detalles.?[tipo != null and tipo.name() == 'REPUESTO'] : {}}
  ">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">
      <i class="bi bi-clipboard-check me-2 text-primary"></i>
      <span th:text="${'Orden de trabajo #' + (orden != null ? orden.id : '-') }">Orden</span>
    </h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" th:href="@{/ordenes}">
        <i class="bi bi-arrow-left me-1"></i> Volver
      </a>
      <a class="btn btn-primary"
         th:if="${orden != null}"
         th:href="@{'/ordenes/' + ${orden.id} + '/editar'}">
        <i class="bi bi-pencil-square me-1"></i> Editar
      </a>
    </div>
  </div>

  <!-- Datos generales -->
  <div class="card mb-3" th:if="${orden != null}">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="text-muted small">Vehículo</div>
          <div class="fw-semibold"
               th:text="${
                 (orden.vehiculo != null ? orden.vehiculo.placa : '-') +
                 ' · ' +
                 (orden.vehiculo != null && orden.vehiculo.marca != null ? orden.vehiculo.marca.nombre : '') +
                 ' ' +
                 (orden.vehiculo != null && orden.vehiculo.modelo != null ? orden.vehiculo.modelo.nombre : '')
               }">-
          </div>
        </div>

        <div class="col-md-3">
          <div class="text-muted small">Estado</div>
          <div class="fw-semibold"
               th:text="${orden.estado != null ? orden.estado.nombre : '-'}">-</div>
        </div>

        <div class="col-md-3">
          <div class="text-muted small">Fecha ingreso</div>
          <div class="fw-semibold"
               th:text="${orden.fechaIngreso != null ? #temporals.format(orden.fechaIngreso, 'yyyy-MM-dd HH:mm') : '-'}">-</div>
        </div>

        <div class="col-md-2">
          <div class="text-muted small">Salida estimada</div>
          <div class="fw-semibold"
               th:text="${orden.fechaSalidaEstimada != null ? #temporals.format(orden.fechaSalidaEstimada, 'yyyy-MM-dd HH:mm') : '-'}">-</div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="text-muted small">Diagnóstico</div>
          <div th:text="${orden.diagnostico != null && !#strings.isEmpty(orden.diagnostico) ? orden.diagnostico : '-'}">-</div>
        </div>
        <div class="col-12">
          <div class="text-muted small">Observaciones</div>
          <div th:text="${orden.observaciones != null && !#strings.isEmpty(orden.observaciones) ? orden.observaciones : '-'}">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Repuestos -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold"><i class="bi bi-box-seam me-2"></i> Repuestos</div>
      <div class="text-muted small"
           th:if="${!#lists.isEmpty(repuestos)}"
           th:text="${#numbers.formatDecimal(#lists.sum(repuestos.![totalLinea]), 1, 'COMMA', 2, 'POINT')}">
        0.00
      </div>
    </div>

    <div class="card-body p-0">
      <div class="p-3 text-muted" th:if="${#lists.isEmpty(repuestos)}">
        No hay repuestos en esta orden.
      </div>

      <div class="table-responsive" th:if="${!#lists.isEmpty(repuestos)}">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Repuesto</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Total</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="d : ${repuestos}">
            <td th:text="${d.descripcion != null && !#strings.isEmpty(d.descripcion) ? d.descripcion : (d.repuesto != null ? d.repuesto.nombre : '-')}">-</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.cantidad, 1, 'COMMA', 2, 'POINT')}">0.00</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.precioUnit, 1, 'COMMA', 2, 'POINT')}">0.00</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.totalLinea, 1, 'COMMA', 2, 'POINT')}">0.00</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Servicios -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="fw-semibold"><i class="bi bi-wrench-adjustable-circle me-2"></i> Servicios</div>
      <div class="text-muted small"
           th:if="${!#lists.isEmpty(servicios)}"
           th:text="${#numbers.formatDecimal(#lists.sum(servicios.![totalLinea]), 1, 'COMMA', 2, 'POINT')}">
        0.00
      </div>
    </div>

    <div class="card-body p-0">
      <div class="p-3 text-muted" th:if="${#lists.isEmpty(servicios)}">
        No hay servicios en esta orden.
      </div>

      <div class="table-responsive" th:if="${!#lists.isEmpty(servicios)}">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Descripción</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Total</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="d : ${servicios}">
            <td th:text="${d.descripcion}">-</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.cantidad, 1, 'COMMA', 2, 'POINT')}">0.00</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.precioUnit, 1, 'COMMA', 2, 'POINT')}">0.00</td>
            <td class="text-end" th:text="${#numbers.formatDecimal(d.totalLinea, 1, 'COMMA', 2, 'POINT')}">0.00</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Totales -->
  <div class="card">
    <div class="card-body">
      <div class="row g-2 justify-content-end">
        <div class="col-auto text-muted">Subtotal Mano de Obra:</div>
        <div class="col-auto fw-semibold"
             th:text="${orden != null && orden.subtotalManoObra != null ? #numbers.formatDecimal(orden.subtotalManoObra, 1, 'COMMA', 2, 'POINT') : '0.00'}">
          0.00
        </div>
      </div>
      <div class="row g-2 justify-content-end">
        <div class="col-auto text-muted">Subtotal Repuestos:</div>
        <div class="col-auto fw-semibold"
             th:text="${orden != null && orden.subtotalRepuestos != null ? #numbers.formatDecimal(orden.subtotalRepuestos, 1, 'COMMA', 2, 'POINT') : '0.00'}">
          0.00
        </div>
      </div>
      <hr class="my-2">
      <div class="row g-2 justify-content-end">
        <div class="col-auto fs-5">Total:</div>
        <div class="col-auto fs-5 fw-bold text-primary"
             th:text="${orden != null && orden.total != null ? #numbers.formatDecimal(orden.total, 1, 'COMMA', 2, 'POINT') : '0.00'}">
          0.00
        </div>
      </div>
    </div>
  </div>

</section>
</body>
</html>
