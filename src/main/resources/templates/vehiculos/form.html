<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{_layout :: head(~{::title})}">
  <title th:text="${vehiculo != null and vehiculo.id != null} ? 'Editar vehículo' : 'Nuevo vehículo'">Vehículo</title>
</head>

<body th:replace="~{_layout :: layout(~{::title}, ~{::section})}">
<section>

  <!-- Header -->
  <div class="form-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="form-title" th:text="${vehiculo != null and vehiculo.id != null} ? 'Editar Vehículo' : 'Nuevo Vehículo'">Vehículo</h1>
        <p class="page-subtitle mt-1" th:text="${vehiculo != null and vehiculo.id != null} ? 'Actualiza la información del vehículo' : 'Registra un nuevo vehículo al sistema'">
          Información del vehículo
        </p>
      </div>
      <a th:href="@{/vehiculos}" class="btn btn-back">
        <i class="bi bi-arrow-left me-1"></i> Volver
      </a>
    </div>
  </div>

  <!-- Formulario -->
  <div class="form-card">
    <form method="post" th:action="@{/vehiculos}" th:object="${vehiculo}">
      
      <!-- Hidden fields -->
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      <input type="hidden" th:if="*{id != null}" th:field="*{id}"/>
      <input type="hidden" th:if="*{version != null}" th:field="*{version}"/>

      <!-- Errores globales -->
      <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger-minimal alert-dismissible fade show mb-4" role="alert">
        <div class="d-flex align-items-start">
          <i class="bi bi-exclamation-circle-fill me-2" style="font-size: 1.25rem;"></i>
          <div class="flex-grow-1">
            <strong class="d-block mb-1">Error al guardar</strong>
            <p th:each="err : ${#fields.globalErrors()}" th:text="${err}" class="mb-0 small">Error</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- Sección: Propietario -->
      <div class="mb-4 pb-3" style="border-bottom: 1px solid var(--border-subtle);">
        <h6 class="text-uppercase" style="font-size: 0.8125rem; font-weight: 600; color: var(--gris-texto); letter-spacing: 0.05em;">
          <i class="bi bi-person-badge me-2"></i>
          Propietario del Vehículo
        </h6>
      </div>

      <div class="row g-3">
        
        <!-- Cliente -->
        <div class="col-md-12">
          <label class="form-label-minimal" for="clienteId">
            Cliente
            <span class="required">*</span>
          </label>
          <div class="position-relative">
            <i class="bi bi-person position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none; z-index: 10;"></i>
            <select class="form-select form-select-minimal" 
                    style="padding-left: 2.5rem;"
                    id="clienteId" 
                    name="clienteId" 
                    required
                    th:classappend="${#fields.hasErrors('cliente')} ? 'form-control-error' : ''">
              <option value="" th:selected="${vehiculo.cliente == null}">-- Seleccione el propietario --</option>
              <option th:each="c : ${clientes}"
                      th:value="${c.id}"
                      th:text="|${c.nombres} ${c.apellidos}|"
                      th:selected="${vehiculo.cliente != null and vehiculo.cliente.id == c.id}">
              </option>
            </select>
          </div>
          <small class="form-helper">Cliente propietario del vehículo</small>
          <span class="error-message" th:if="${#fields.hasErrors('cliente')}" th:errors="*{cliente}">Error Cliente</span>
        </div>

      </div>

      <!-- Sección: Identificación -->
      <div class="mb-4 pb-3 mt-4" style="border-bottom: 1px solid var(--border-subtle);">
        <h6 class="text-uppercase" style="font-size: 0.8125rem; font-weight: 600; color: var(--gris-texto); letter-spacing: 0.05em;">
          <i class="bi bi-card-text me-2"></i>
          Identificación del Vehículo
        </h6>
      </div>

      <div class="row g-3">
        
        <!-- Placa -->
        <div class="col-md-4">
          <label class="form-label-minimal" for="placa">
            Placa
            <span class="required">*</span>
          </label>
          <div class="position-relative">
            <i class="bi bi-credit-card-2-front position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none;"></i>
            <input type="text" 
                   class="form-control form-control-minimal text-uppercase" 
                   style="padding-left: 2.5rem; font-weight: 600;"
                   id="placa" 
                   th:field="*{placa}" 
                   maxlength="20" 
                   required
                   placeholder="P123-456"
                   th:classappend="${#fields.hasErrors('placa')} ? 'form-control-error' : ''"/>
          </div>
          <small class="form-helper">Número de placa oficial</small>
          <span class="error-message" th:if="${#fields.hasErrors('placa')}" th:errors="*{placa}">Error Placa</span>
        </div>

        <!-- Año -->
        <div class="col-md-4">
          <label class="form-label-minimal" for="anio">Año</label>
          <div class="position-relative">
            <i class="bi bi-calendar-event position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none;"></i>
            <input type="number" 
                   class="form-control form-control-minimal" 
                   style="padding-left: 2.5rem;"
                   id="anio" 
                   th:field="*{anio}" 
                   min="1900" 
                   max="2100"
                   placeholder="2024"
                   th:classappend="${#fields.hasErrors('anio')} ? 'form-control-error' : ''"/>
          </div>
          <small class="form-helper">Año de fabricación</small>
          <span class="error-message" th:if="${#fields.hasErrors('anio')}" th:errors="*{anio}">Error Año</span>
        </div>

        <!-- Color -->
        <div class="col-md-4">
          <label class="form-label-minimal" for="color">Color</label>
          <div class="position-relative">
            <i class="bi bi-palette position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none;"></i>
            <input type="text" 
                   class="form-control form-control-minimal" 
                   style="padding-left: 2.5rem;"
                   id="color" 
                   th:field="*{color}" 
                   maxlength="40"
                   placeholder="Blanco"
                   th:classappend="${#fields.hasErrors('color')} ? 'form-control-error' : ''"/>
          </div>
          <small class="form-helper">Color principal del vehículo</small>
          <span class="error-message" th:if="${#fields.hasErrors('color')}" th:errors="*{color}">Error Color</span>
        </div>

        <!-- VIN -->
        <div class="col-md-12">
          <label class="form-label-minimal" for="vin">VIN (Número de Serie)</label>
          <div class="position-relative">
            <i class="bi bi-upc-scan position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none;"></i>
            <input type="text" 
                   class="form-control form-control-minimal text-uppercase" 
                   style="padding-left: 2.5rem; font-family: monospace;"
                   id="vin" 
                   th:field="*{vin}" 
                   maxlength="40"
                   placeholder="1HGBH41JXMN109186"
                   th:classappend="${#fields.hasErrors('vin')} ? 'form-control-error' : ''"/>
          </div>
          <small class="form-helper">Número de identificación vehicular (opcional)</small>
          <span class="error-message" th:if="${#fields.hasErrors('vin')}" th:errors="*{vin}">Error VIN</span>
        </div>

      </div>

      <!-- Sección: Marca y Modelo -->
      <div class="mb-4 pb-3 mt-4" style="border-bottom: 1px solid var(--border-subtle);">
        <h6 class="text-uppercase" style="font-size: 0.8125rem; font-weight: 600; color: var(--gris-texto); letter-spacing: 0.05em;">
          <i class="bi bi-tag me-2"></i>
          Marca y Modelo
        </h6>
      </div>

      <div class="row g-3">
        
        <!-- Marca -->
        <div class="col-md-6">
          <label class="form-label-minimal" for="marcaId">Marca</label>
          <div class="position-relative">
            <i class="bi bi-award position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none; z-index: 10;"></i>
            <select class="form-select form-select-minimal" 
                    style="padding-left: 2.5rem;"
                    id="marcaId" 
                    name="marcaId"
                    th:classappend="${#fields.hasErrors('marca')} ? 'form-control-error' : ''">
              <option value="" th:selected="${vehiculo.marca == null}">-- Seleccione marca --</option>
              <option th:each="m : ${marcas}"
                      th:value="${m.id}"
                      th:text="${m.nombre}"
                      th:selected="${vehiculo.marca != null and vehiculo.marca.id == m.id}">
              </option>
            </select>
          </div>
          <small class="form-helper">Fabricante del vehículo</small>
          <span class="error-message" th:if="${#fields.hasErrors('marca')}" th:errors="*{marca}">Error Marca</span>
        </div>

        <!-- Modelo -->
        <div class="col-md-6">
          <label class="form-label-minimal" for="modeloId">Modelo</label>
          <div class="position-relative">
            <i class="bi bi-car-front position-absolute" style="left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gris-texto); pointer-events: none; z-index: 10;"></i>
            <select class="form-select form-select-minimal" 
                    style="padding-left: 2.5rem;"
                    id="modeloId" 
                    name="modeloId"
                    th:classappend="${#fields.hasErrors('modelo')} ? 'form-control-error' : ''"
                    th:disabled="${#lists.isEmpty(modelos)}">
              <option value=""
                      th:text="${(modelos != null and !#lists.isEmpty(modelos)) ? '-- Seleccione modelo --' : '-- Seleccione marca primero --'}">
                -- Seleccione marca primero --
              </option>
              <option th:each="mo : ${modelos}"
                      th:value="${mo.id}"
                      th:text="${mo.nombre}"
                      th:selected="${vehiculo.modelo != null and vehiculo.modelo.id == mo.id}">
              </option>
            </select>
          </div>
          <small class="form-helper">Modelo específico del vehículo</small>
          <span class="error-message" th:if="${#fields.hasErrors('modelo')}" th:errors="*{modelo}">Error Modelo</span>
        </div>

      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <button class="btn btn-primary-form" type="submit">
          <i class="bi bi-check-lg me-1"></i>
          <span th:text="${vehiculo != null and vehiculo.id != null} ? 'Actualizar Vehículo' : 'Guardar Vehículo'">Guardar</span>
        </button>
        <a th:href="@{/vehiculos}" class="btn btn-secondary-form">
          <i class="bi bi-x-lg me-1"></i> Cancelar
        </a>
      </div>

    </form>
  </div>

  <!-- Nota informativa -->
  <div class="card-minimal mt-3" style="background: rgba(23, 162, 184, 0.03); border-color: rgba(23, 162, 184, 0.15);">
    <div class="card-body py-3">
      <div class="d-flex align-items-start gap-2">
        <i class="bi bi-lightbulb" style="color: var(--info); font-size: 1.125rem; flex-shrink: 0; margin-top: 0.125rem;"></i>
        <div>
          <strong style="color: var(--info); font-size: 0.875rem;">Carga dinámica de modelos</strong>
          <p class="mb-0 text-muted small mt-1">
            Selecciona primero la marca para que se carguen automáticamente los modelos disponibles.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Script de carga de modelos (SIN CAMBIOS) -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    const selectedModeloId = /*[[${(vehiculo != null and vehiculo.modelo != null) ? vehiculo.modelo.id : null}]]*/ null;
    /*]]>*/

    const marcaSelect = document.getElementById('marcaId');
    const modeloSelect = document.getElementById('modeloId');

    async function cargarModelos() {
      const marcaId = marcaSelect.value;
      modeloSelect.innerHTML = '<option value="">-- cargando... --</option>';

      if (!marcaId) {
        modeloSelect.innerHTML = '<option value="">-- Seleccione marca primero --</option>';
        modeloSelect.disabled = true;
        return;
      }

      try {
        const base = /*[[@{/api/modelos/by-marca/}]]*/ '/api/modelos/by-marca/';
        const response = await fetch(base + marcaId);
        if (!response.ok) throw new Error('Error al cargar modelos');

        const modelos = await response.json();
        modeloSelect.innerHTML = '<option value="">-- Seleccione modelo --</option>';

        if (!Array.isArray(modelos) || modelos.length === 0) {
          modeloSelect.innerHTML = '<option value="">-- no hay modelos --</option>';
          modeloSelect.disabled = true;
          return;
        }

        modelos.forEach((modelo) => {
          const opt = new Option(modelo.nombre, modelo.id);
          if (selectedModeloId != null && String(modelo.id) === String(selectedModeloId)) {
            opt.selected = true;
          }
          modeloSelect.add(opt);
        });
        modeloSelect.disabled = false;
      } catch (e) {
        console.error(e);
        modeloSelect.innerHTML = '<option value="">-- error al cargar --</option>';
        modeloSelect.disabled = true;
      }
    }

    marcaSelect.addEventListener('change', cargarModelos);
    document.addEventListener('DOMContentLoaded', () => {
      if (marcaSelect.value) cargarModelos();
      else modeloSelect.disabled = true;
    });
  </script>

</section>
</body>
</html>